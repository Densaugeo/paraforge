<!doctype html>
<html>
<head>
  <title>MicroPython Test</title>
</head>

<body>
  <pre id="micropython-stdout"></pre>
</body>

<script type="module">
import * as paraforge from './paraforge.js'
window.paraforge = paraforge

let res = await fetch('../examples/first_model.pf.py', { cache: 'reload' })
let res_blob = await res.blob()
let res_array_buffer = await res_blob.arrayBuffer()
let first_model_py = new Uint8Array(res_array_buffer)

const paraforge_class_instance = new paraforge.Paraforge()
await paraforge_class_instance.init(false, 'first_model', first_model_py)

paraforge_class_instance.addEventListener('stderr', e => {
  document.getElementById('micropython-stdout').innerHTML +=
    `<text style="color:#f00">${e.line}</text>`
})
paraforge_class_instance.addEventListener('stdout', e => {
  document.getElementById('micropython-stdout').innerHTML += e.line
})

await paraforge_class_instance.runPython(`
  import ${'first_model'}
  ${'first_model'}.gen_${'first_model'}(${[]})
`)
await paraforge_class_instance.runPython(`
  import js
  print(dir(js))
  print(js.test_function(4))
  print(js.test_string_function('string from MicroPython side'))
  print()
  
  import time
  print('Sleeping...', end='')
  time.sleep(1)
  print('OK')
  print()
  
  import random
  print(random.random())
  print()
  
  big_list = []
  for i in range(1e+5):
      big_list.append(i)
  print(big_list[-1])
  print()
  
  #1/0
`)

res = await fetch('../test-files/first_model.glb', { cache: 'reload' })
res_blob = await res.blob()
res_array_buffer = await res_blob.arrayBuffer()
window.expected_glb = new Uint8Array(res_array_buffer)
window.actual_glb = await paraforge_class_instance.serialize()
window.decoder = new TextDecoder()
console.log('Is the actual .glb as expected?')
console.log(decoder.decode(expected_glb) == decoder.decode(actual_glb))
//console.log(decoder.decode(expected_glb))
//console.log(decoder.decode(actual_glb))
for(let i = 0; i < expected_glb.length; ++i) {
  if(expected_glb[i] != actual_glb[i]) {
    console.log(`First difference at ${i}`)
    break
  }
}
</script>
</html>
